<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <script type="text/javascript" src="js/utils.js"></script>
    <script type="text/javascript" src="js/modplayer.js"></script>
    <script type="text/javascript">
    var moduleList = [
        {file: 'agony.mod', author: 'Tim Wright'},
        {file: 'all_that_she_wants.mod', author: 'Crossair'},
        {file: 'bigtime.mod', author: 'ISO/Axis Group'},
        {file: 'cannonfodder.mod', author: 'John Hare'},
        {file: 'desert_strike.mod', author: 'Jason Whitley'},
        {file: 'LotusII.mod', author: 'Barry Leitch'},
        {file: 'projectx.mod', author: 'Allister Brimble'},
        {file: 'silkworm.mod', author: 'Barry Leitch'}
    ],
    selectedMod = 0,
    prefix = 'audio/';

    function Toast(id) {
        this.container = document.getElementById(id);
    }

    Toast.prototype = {
        show(message, timeout = 2750) {
            this.container.MaterialSnackbar.showSnackbar({
                timeout: timeout,
                message: message
            });
        }
    }

    window.onload = function() {
        var canvas = document.getElementById('visualizer'),
            effect = 1,
            effects = [],
            ctx = canvas.getContext('2d'),
            canvasWidth = canvas.width,
            canvasHeight = canvas.height,
            toast = new Toast('info-snackbar');

        document.addEventListener('moduleLoaded', (event) => {
            toast.show(`Module loaded: ${moduleList[selectedMod].file}`);

            const samples = event.data.samples;
            let str = '';
            for (let i = 0; i < samples.length; ++i) {
                if (samples[i].name.length) {
                    str += `<li>${samples[i].name}</li>`;
                }
            }

            document.querySelector('.sample-list').innerHTML = str;

            document.querySelector('.song-title').innerText = event.data.title;
            document.querySelector('.title').innerText = moduleList[selectedMod].file;
            document.querySelector('.author').innerText = moduleList[selectedMod].author;
            document.querySelector('.song-length').innerText = event.data.length;
            document.querySelector('.song-samples').innerText = event.data.samples.length;
            document.querySelector('.song-positions').innerText = event.data.positions;
            document.querySelector('.song-patterns').innerText = event.data.patterns;

            document.querySelector('#loader').classList.remove('is-active');

            document.querySelectorAll('.controls button').forEach((button) => {
                button.style.display = 'inline-block';
            });

            togglePlayButton();
        });

        var modNav = document.querySelector('.nav-module'),
            options = '';

        moduleList.forEach((module, i) => {
            options += `<a onclick="loadModule(${i});return false;" href="#" class="mdl-navigation__link mod_${i} `;
            if (i === selectedMod) {
                options += ' selected';
            }
            options += `">${module.file}</a>`;
        });

        modNav.innerHTML = options;

        componentHandler.upgradeDom();

        document.addEventListener('keyup', (e) => e.keyCode === 32 && togglePlay());

        document.addEventListener('analyzer_ready', (event) => {
            requestAnimationFrame(() => {
                effects[effect](event.data);
            });
        });

        canvas.onclick = () => {
            effect++;
            if (effect >= effects.length) {
                effect = 0;
            }
        };

        function drawBars(amplitudeArray) {
            var bufferLength = amplitudeArray.length;
            ctx.fillStyle = 'rgb(0, 0, 0)';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            var barWidth = (canvasWidth / bufferLength) * 2.5 - 1;
            barWidth *= 2;
            var barHeight;
            var x = 0;

            for (var i = 0; i < bufferLength; i++) {
                barHeight = amplitudeArray[i];

                ctx.fillStyle = 'rgb(' + (barHeight + 100) + ',50,50)';
                ctx.fillRect(x, canvasHeight - barHeight / 2, barWidth, barHeight / 2);

                x += barWidth;
            }
        }

        function drawOscillo(amplitudeArray) {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            for (var i = 0; i < amplitudeArray.length; i++) {
                var value = amplitudeArray[i] / 256;
                var y = canvasHeight - (canvasHeight * value) - 1;
                ctx.fillStyle = '#000000';
                ctx.fillRect(i, y, 1, 1);
            }
        }

        function drawOscillo2(amplitudeArray) {
            var bufferLength = amplitudeArray.length;

            ctx.fillStyle = "rgb(200, 200, 200)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.lineWidth = 2;
            ctx.strokeStyle = "rgb(0, 0, 0)";

            ctx.beginPath();

            var sliceWidth = canvas.width * 1.0 / bufferLength;
            var x = 0;

            for (var i = 0; i < bufferLength; i++) {

                var v = amplitudeArray[i] / 128.0;
                var y = v * canvas.height / 2;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
        }

        effects.push(drawBars,drawOscillo);

        ModPlayer.init({
            canvas: canvas
        }).then(() => {
            loadModule(selectedMod, false);
        });
    }

    function togglePlayButton() {
        document.querySelector('button.play i').innerText = ModPlayer.playing && 'pause' || 'play_arrow';
    }

    function togglePlay() {
        ModPlayer.play();
        togglePlayButton();
    }

    function stop() {
        ModPlayer.stop();
        togglePlayButton();
    }

    function loadModule(moduleIndex, hideDrawer = true) {
        var moduleName = moduleList[moduleIndex].file;

        selectedMod = moduleIndex;

        if (ModPlayer.ready && moduleName) {
            // I guess that's the best way to programmatically hide the drawer
            // since MDL does not provide any API to do that
            if (hideDrawer) {
                document.querySelector('.mdl-layout__obfuscator').click();
            }

            document.querySelector('#loader').classList.add('is-active');

            document.querySelectorAll('.controls button').forEach((button) => {
                button.style.display = 'none';
            });

            document.querySelector('a.mdl-navigation__link.selected').classList.toggle('selected');
            document.querySelector(`a.mdl-navigation__link.mod_${moduleIndex}`).classList.add('selected');

            ModPlayer.loadModule(prefix + moduleName);
        }
    }

    </script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-deep_purple.min.css">
    <style type="text/css">
        /* mdl */
        .page-content {
            display: flex;
            justify-content: center;
            padding: 40px;
        }

        a.mdl-navigation__link.selected:before {
            font-family: 'Material Icons';
            font-weight: 400;
            font-style: normal;
            font-size: 24px;
            line-height: 24px;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            word-wrap: normal;
            content: 'volume_up';
            height: 18px;
            color: black;
            position: absolute;
            left: 11px;
        }

        .mdl-mini-footer {
            justify-content: center;
        }

        .mdl-card__title h2 {
            color: black;
        }

        .mdl-layout__drawer .mdl-navigation .mdl-navigation__link.selected {
            padding-left: 40px;
        }

        .mdl-mini-footer--link-list li, .mdl-mini-footer__link-list li{
            margin-right: 32px;
        }

        .author{
            font-style:italic;
        }
    </style>
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="js/audioworklet-polyfill.js"></script>
</head>
<body>
    <!-- Always shows a header, even in smaller screens. -->
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
        <header class="mdl-layout__header">
            <div class="mdl-layout__header-row">
                <!-- Title -->
                <span class="mdl-layout-title">Modplayer-js</span>
                <!-- Add spacer, to align navigation to the right -->
                <div class="mdl-layout-spacer"></div>
                <!-- Navigation. We hide it in small screens. -->
                <nav class="mdl-navigation controls">
                    <!-- <a class="mdl-navigation__link mdl-navigation__link--icon github" href="https://github.com/warpdesign/modplayer-js"><i class="material-icons">link</i><span>GitHub</span></a> -->
                    <button class="mdl-button mdl-js-button mdl-button--icon play" style="display:none;" onclick="togglePlay()">
                        <i class="material-icons">play_arrow</i>
                    </button>
                    <button class="mdl-button mdl-js-button mdl-button--icon play" style="display:none;" onclick="stop()">
                        <i class="material-icons">stop</i>
                    </button>
                    <div id="loader" class="mdl-spinner mdl-js-spinner is-active"></div>
                </nav>
            </div>
        </header>
        <div class="mdl-layout__drawer">
            <span class="mdl-layout-title">Choose Module</span>
            <nav class="mdl-navigation nav-module">
            </nav>
        </div>
        <main class="mdl-layout__content">
            <div class="page-content">
                <!-- Wide card with share menu button -->
                <style>
                    .demo-card-wide.mdl-card {
                        width: 512px;
                        position:relative;
                    }

                    .demo-card-wide>.mdl-card__title {
                        color: #fff;
                        height: 196px;
                        /* Permalink - use to edit and share this gradient: http://colorzilla.com/gradient-editor/#2c2c2c+1,000000+9,2b2b2b+50,bababa+54,ffffff+100 */
                        background: rgb(44,44,44); /* Old browsers */
                        background: -moz-linear-gradient(top, rgba(44,44,44,1) 1%, rgba(0,0,0,1) 9%, rgba(43,43,43,1) 50%, rgba(186,186,186,1) 54%, rgba(255,255,255,1) 100%); /* FF3.6-15 */
                        background: -webkit-linear-gradient(top, rgba(44,44,44,1) 1%,rgba(0,0,0,1) 9%,rgba(43,43,43,1) 50%,rgba(186,186,186,1) 54%,rgba(255,255,255,1) 100%); /* Chrome10-25,Safari5.1-6 */
                        background: linear-gradient(to bottom, rgba(44,44,44,1) 1%,rgba(0,0,0,1) 9%,rgba(43,43,43,1) 50%,rgba(186,186,186,1) 54%,rgba(255,255,255,1) 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
                    }

                    .demo-card-wide>.mdl-card__menu, .demo-card-wide>.mdl-card__title {
                        color: #777;
                    }

                    .demo-card-wide canvas{
                        position:absolute;
                        z-index:0;
                        top:0;
                        left:0;
                    }
                </style>

                <div class="demo-card-wide mdl-card mdl-shadow--2dp">
                    <div class="mdl-card__title">
                        <canvas width="512" height="128" id="visualizer"></canvas>
                        <h2 class="mdl-card__title-text"><i class="material-icons">audiotrack</i><span class="title"></span>&nbsp;by&nbsp;<span class="author"></span></h2>
                    </div>
                    <div class="mdl-card__supporting-text">
                        <div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
                            <div class="mdl-tabs__tab-bar">
                                <a href="#modinfo-panel" class="mdl-tabs__tab is-active">Module Info</a>
                                <a href="#samples-panel" class="mdl-tabs__tab">Samples</a>
                            </div>

                            <div class="mdl-tabs__panel is-active" id="modinfo-panel">
                                <ul>
                                    <li>Title: <span class="song-title"></span></li>
                                    <li>Length: <span class="song-length"></span></li>
                                    <li>Samples: <span class="song-samples"></span></li>
                                    <li>Positions: <span class="song-positions"></span></li>
                                    <li>Patterns: <span class="song-patterns"></span></li>
                                </ul>
                            </div>
                            <div class="mdl-tabs__panel" id="samples-panel">
                                <ul class="sample-list">
                                </ul>
                            </div>
                        </div>
                    </div>
                    <!-- <div class="mdl-card__actions mdl-card--border">
                        <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
                            Get Started
                        </a>
                    </div> -->
                    <div class="mdl-card__menu">
                        <button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect">
                            <i class="material-icons">attachment</i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
        <footer class="mdl-mini-footer">
            <div class="mdl-mini-footer__left-section">
                <ul class="mdl-mini-footer__link-list">
                    <li><a href="https://github.com/warpdesign/modplayer-js">GitHub</a></li>
                    <li><a href="https://twitter.com/warpdesign_">Twitter</a></li>
                    <li><a href="https://warpdesign.fr">Warpdesign ‚ù§ WebAudio</a></li>
                </ul>
            </div>
        </footer>
        <div id="info-snackbar" class="mdl-js-snackbar mdl-snackbar">
            <div class="mdl-snackbar__text content"></div>
            <button class="mdl-snackbar__action" type="button"></button>
        </div>
    </div>
</body>
</html>