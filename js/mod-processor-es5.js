function t(e){return t=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},t(e)}function e(t,s){return e=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},e(t,s)}function s(t,i,o){return s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}()?Reflect.construct.bind():function(t,s,i){var o=[null];o.push.apply(o,s);var a=new(Function.bind.apply(t,o));return i&&e(a,i.prototype),a},s.apply(null,arguments)}function i(o){var a="function"==typeof Map?new Map:void 0;return i=function(i){if(null===i||!function(t){try{return-1!==Function.toString.call(t).indexOf("[native code]")}catch(e){return"function"==typeof t}}(i))return i;if("function"!=typeof i)throw new TypeError("Super expression must either be null or a function");if(void 0!==a){if(a.has(i))return a.get(i);a.set(i,o)}function o(){return s(i,arguments,t(this).constructor)}return o.prototype=Object.create(i.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),e(o,i)},i(o)}var o=function(t,e,s){void 0===s&&(s=0);for(var i=new Uint8Array(t),o="",a=!1,n=0;!a;++n){var r=i[s+n];(a=0===r)||(o+=String.fromCharCode(r))}return o},a=function(t,e,s){return void 0===e&&(e=0),void 0===s&&(s=!1),new DataView(t).getUint16(e,s)},n=new Array(4);n[0]=new Float32Array(64);for(var r=0;r<n[0].length;++r)n[0][r]=64*Math.sin(2*Math.PI*(r/64));var p=/*#__PURE__*/function(t){var s,i;function n(){var e;return(e=t.call(this)||this).port.onmessage=e.handleMessage.bind(function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(e)),e.patternLength=1024,e}i=t,(s=n).prototype=Object.create(i.prototype),s.prototype.constructor=s,e(s,i);var r=n.prototype;return r.handleMessage=function(t){var e=this;switch(t.data.message){case"init":this.mixingRate=t.data.mixingRate,this.audioWorkletSupport=t.data.audioWorkletSupport;break;case"loadModule":this.prepareModule(t.data.buffer);break;case"setPlay":this.ready&&(this.playing=t.data.playing);break;case"reset":this.ready&&this.resetValues();break;case"setPlayingChannels":console.log(t.data.channels),t.data.channels.forEach(function(t,s){var i=e.channels[s];i&&(i.off=!t)});break;case"speedUp":console.log("speed up",t.data.speedUp),this.speedUp=t.data.speedUp,this.calcTickSpeed()}},r.postMessage=function(t){this.port.postMessage(t)},r.process=function(t,e,s){return this.ready&&this.playing?this.mix(e):this.emptyOutputBuffer(e),!0},r.emptyOutputBuffer=function(t){if(this.audioWorkletSupport)for(var e=t.length,s=t[0][0].length,i=0;i<e;++i)for(var o=0;o<s;++o)t[i][0][o]=0;else for(var a=t[0].length,n=t[0][0].length,r=0;r<a;++r)for(var p=0;p<n;++p)t[0][r][p]=0},r.init=function(){this.name="",this.samples=[],this.patterns=[],this.positions=[],this.songLength=0,this.channels||(this.channels=new Array(4)),this.maxSamples=0,this.bpm=125,this.speed=6,this.speedUp=1,this.position=0,this.pattern=0,this.row=0,this.samplesPerTick=0,this.filledSamples=0,this.ticks=0,this.newTick=!0,this.rowRepeat=0,this.rowJump=-1,this.skipPattern=!1,this.jumpPattern=-1,this.buffer=null,this.started=!1,this.ready=!1,this.playing=!1},r.resetValues=function(){this.started=!1,this.position=0,this.row=0,this.ticks=0,this.filledSamples=0,this.speed=6,this.newTick=!0,this.rowRepeat=0,this.rowJump=-1,this.skipPattern=!1,this.jumpPattern=-1,this.createChannels(),this.decodeRow()},r.createChannels=function(){for(var t=0;t<this.channels.length;++t){var e={sample:-1,samplePos:0,period:0,volume:64,slideTo:-1,slideSpeed:0,delay:0,vform:0,vdepth:0,vspeed:0,vpos:0,loopInitiated:!1,id:t,cmd:0};this.channels[t]?Object.assign(this.channels[t],e):this.channels[t]=e}},r.isModule=function(t){return t.byteLength>20&&0===new DataView(t).getUint8(19)},r.prepareModule=function(t){console.log("Decoding module data..."),this.isModule(t)?(this.ready=!1,this.init(),this.buffer=t,this.name=o(this.buffer),this.getInstruments(),this.getPatternData(),this.getSampleData(),this.calcTickSpeed(),this.createChannels(),this.resetValues(),this.ready=!0,this.postMessage({message:"moduleLoaded",data:{samples:this.samples,title:this.name,length:this.buffer.byteLength,positions:this.positions.length,patterns:this.patterns.length}})):this.postMessage({message:"moduleLoadError"})},r.detectMaxSamples=function(){var t=o(this.buffer,0,1080);this.maxSamples=t.match("M.K.")?31:15,this.patternOffset=15===this.maxSamples?600:1084},r.calcTickSpeed=function(){this.samplesPerTick=60*this.mixingRate/(this.bpm*this.speedUp)/24},r.mix=function(t){for(var e=this.audioWorkletSupport&&t[0][0].length||t[0][0].length,s=0;s<e;++s){var i=0;this.audioWorkletSupport?(t[0][0][s]=0,t[1][0][s]=0,t[2][0][s]=0,t[3][0][s]=0):(t[0][0][s]=0,t[0][1][s]=0),this.tick();for(var o=0;o<this.channels.length;++o){var a=this.channels[o];i^=1&o;var n=this.audioWorkletSupport?t[o][0]:t[0][i];if(this.newTick&&a.cmd&&this.executeEffect(a),!a.off&&a.period&&a.sample>-1&&!a.done&&this.ticks>=a.delay){var r=this.samples[a.sample];n[s]+=r.data[Math.floor(a.samplePos)]*a.volume/64,a.samplePos+=7093789.2/(2*a.period*this.mixingRate),a.done||(r.repeatLength||r.repeatStart?a.samplePos>=r.repeatStart+r.repeatLength&&(a.samplePos=r.repeatStart):a.samplePos>r.length&&(a.samplePos=0,a.done=!0))}}this.filledSamples++,this.newTick=!1}},r.tick=function(){this.filledSamples>this.samplesPerTick&&(this.newTick=!0,this.ticks++,this.filledSamples=0,this.ticks>this.speed-1&&(this.ticks=0,this.rowRepeat<=0&&this.row++,(this.row>63||this.skipPattern)&&(this.skipPattern=!1,this.jumpPattern>-1?(this.position=this.jumpPattern,this.jumpPattern=-1,this.getNextPattern()):this.getNextPattern(!0)),this.rowJump>-1&&(this.row=this.rowJump,this.rowJump=-1),this.row>63&&(this.row=0),this.decodeRow()))},r.getNextPattern=function(t){t&&this.position++,this.position>this.positions.length-1&&(console.log("Warning: last position reached, going back to 0"),this.position=0);for(var e=0;e<this.channels.length;++e)this.channels[e].loopInitiated=!1;this.pattern=this.positions[this.position]},r.decodeRow=function(){this.started||(this.started=!0,this.getNextPattern());for(var t=new Uint8Array(this.patterns[this.pattern],16*this.row,16),e=0;e<this.channels.length;++e){var s=4*e,i=(15&t[s])<<8|t[1+s],o=(240&t[s]|t[2+s]>>4)-1,a=15&t[2+s],n=t[3+s],r=this.channels[e];r.delay=0,a?14===a?(r.cmd=224+(n>>4),r.data=15&n):(r.cmd=a,r.data=n):r.cmd=0,o>-1&&(3!==r.cmd&&5!==r.cmd&&(r.samplePos=0),r.done=!1,r.sample=o,r.volume=this.samples[o].volume),i&&(r.done=!1,3!==r.cmd&&5!==r.cmd?(r.period=i,r.samplePos=0):r.slideTo=i)}},r.executeEffect=function(t){try{h[t.cmd](this,t)}catch(e){console.warn("effect not implemented: "+t.cmd.toString(16).padStart(2,"0")+"/"+t.data.toString(16).padStart(2,"0"))}},r.getInstruments=function(){this.detectMaxSamples(),this.samples=new Array;for(var t=20,e=new Uint8Array(this.buffer),s=0;s<this.maxSamples;++s){var i={name:o(this.buffer,0,t),length:2*a(this.buffer,t+22),fintune:240&e[t+24],volume:e[t+25],repeatStart:2*a(this.buffer,t+26),repeatLength:2*a(this.buffer,t+28),data:null};2===i.repeatLength&&(i.repeatLength=0,2===i.length&&(i.length=0)),i.repeatLength>i.length&&(i.repeatLength=0,i.repeatStart=0),this.samples.push(i),t+=30}},r.getPatternData=function(){var t=new Uint8Array(this.buffer,15===this.maxSamples?470:950);this.songLength=t[0];for(var e=2,s=0,i=0;i<this.songLength;++i){var o=t[e+i];this.positions.push(o),o>s&&(s=o)}e=this.patternOffset;for(var a=0;a<=s;++a)this.patterns.push(this.buffer.slice(e,e+this.patternLength)),e+=this.patternLength},r.getSampleData=function(){for(var t=this.patternOffset+this.patterns.length*this.patternLength,e=0;e<this.samples.length;++e){for(var s=this.samples[e].length,i=new Float32Array(s),o=t+s>this.buffer.byteLength?this.buffer.byteLength-t:s,a=new Int8Array(this.buffer,t,o),n=0;n<s;++n)i[n]=a[n]/128;this.samples[e].data=i,t+=o}},r.toggleLowPass=function(t){this.postMessage({message:"toggleLowPass",data:{activate:t}})},n}(/*#__PURE__*/i(AudioWorkletProcessor));registerProcessor("mod-processor",p);var h={1:function(t,e){t.ticks&&(e.period-=e.data,e.period<113&&(e.period=113))},2:function(t,e){t.ticks&&(e.period+=e.data,e.period>856&&(e.period=856))},3:function(t,e,s){t.ticks?e.slideTo&&t.ticks?e.period<e.slideTo?(e.period+=e.slideSpeed,e.period>e.slideTo&&(e.period=e.slideTo)):e.period>e.slideTo&&(e.period-=e.slideSpeed,e.period<e.slideTo&&(e.period=e.slideTo)):console.log("portamento + volume slide: keeping previous values"):!s&&e.data&&(e.slideSpeed=e.data)},4:function(t,e){if(!t.ticks){var s=15&e.data,i=(240&e.data)>>4;i&&s&&(e.vdepth=s,e.vspeed=i),e.vform>3&&(e.vpos=0)}e.period+=e.vdepth*n[3&e.vform][e.vpos]/63,e.vpos+=e.vspeed,e.vpos>63&&(e.vpos=e.vpos-64)},5:function(t,e){this[3](t,e),this[10](t,e)},6:function(t,e){this[4](t,e),this[10](t,e)},9:function(t,e){t.ticks||(e.samplePos=256*e.data)},10:function(t,e){if(t.ticks){var s=e.data>>4,i=15&e.data;i?s||(e.volume-=i):e.volume+=s,e.volume>63?e.volume=63:e.volume<0&&(e.volume=0)}},11:function(t,e){e.data>=0&&e.data<=t.patterns.length-1&&(t.skipPattern=!0,t.jumpPattern=e.data,t.rowJump=0)},12:function(t,e){t.ticks||(e.volume=e.data,e.volume>63&&(e.volume=63))},13:function(t,e){t.ticks||(t.rowJump=10*((240&e.data)>>4)+(15&e.data),t.skipPattern=!0)},224:function(t,e){t.ticks||(console.log("need to toggle lowPass",!!e.data),t.toggleLowPass(!!e.data))},228:function(t,e){},230:function(t,e){t.ticks||(0===e.data?e.loopInitiated?e.loops===e.loopCount&&(e.loopInitiated=!1):(e.loopInitiated=!0,e.loopStart=t.row,e.loopCount=0):e.loopInitiated&&(t.rowJump=e.loopStart,e.loopCount?e.loops++:(e.loopCount=e.data,e.loops=1)))},233:function(t,e){(t.ticks+1)%e.data||(console.log("retriggering note!",t.ticks+1),e.samplePos=0,e.done=!1)},234:function(t,e){t.ticks||(e.volume+=e.data,e.volume>63&&(e.volume=63))},235:function(t,e){t.ticks||(e.volume-=e.data,e.volume<0&&(e.volume=0))},237:function(t,e){t.ticks||(e.delay=e.data)},238:function(t,e){t.ticks||(t.rowRepeat?t.rowRepeat&&t.rowRepeat--:(t.rowRepeat=e.data,console.log("setting repeat to",t.rowRepeat)))},15:function(t,e){t.ticks||(e.data<32?t.speed=e.data:(t.bpm=e.data,t.calcTickSpeed()))}};
//# sourceMappingURL=modplayer-js.js.map
